---
phase: 71-windfield-migration
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/maya_grass_gen/generator.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "MASH distribute node attributes can be set after addNode()"
    - "MASH python node pythonCode attribute can be set after addNode()"
    - "Error messages clearly indicate what node creation failed"
  artifacts:
    - path: "src/maya_grass_gen/generator.py"
      provides: "MASH node creation with correct name resolution"
      contains: "cmds.ls"
  key_links:
    - from: "mash_network.addNode()"
      to: "cmds.setAttr()"
      via: "node name resolution using cmds.ls() or getNodeName()"
      pattern: "getNodeName|cmds\\.ls"
---

<objective>
Fix MASH node naming issue where addNode() returns a wrapper object whose .name property
does not match the actual Maya node name, causing setAttr() to fail.

Purpose: Close UAT gap - RuntimeError at generator.py:561 where setAttr cannot find node

Output: Working MASH network creation that correctly resolves node names
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/71-windfield-migration/71-UAT.md
@src/maya_grass_gen/generator.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add helper function to resolve MASH node names</name>
  <files>src/maya_grass_gen/generator.py</files>
  <action>
  Add a helper function `_get_mash_node_name()` inside the GrassGenerator class that:

  1. Takes the node wrapper returned by addNode() and a fallback hint (e.g., "Distribute")
  2. Tries multiple approaches to get the actual Maya node name:
     - First try: node.getNodeName() if available (MASH API method)
     - Second try: node.name if it's a string that exists in scene (cmds.objExists)
     - Third try: cmds.ls() to find nodes matching the pattern (e.g., "*_Distribute*")
  3. Returns the resolved node name as a string
  4. Raises RuntimeError with clear message if node cannot be found

  Implementation pattern:
  ```python
  def _get_mash_node_name(self, node_wrapper: Any, node_type: str) -> str:
      """Resolve actual Maya node name from MASH node wrapper.

      The MASH API addNode() returns a wrapper object whose .name property
      may not match the actual Maya node name. This function tries multiple
      approaches to find the correct name.

      Args:
          node_wrapper: object returned by mash_network.addNode()
          node_type: type hint for error messages (e.g., "Distribute", "Python")

      Returns:
          actual Maya node name as string

      Raises:
          RuntimeError: if node cannot be found in scene
      """
      # try getNodeName() method (MASH API)
      if hasattr(node_wrapper, 'getNodeName'):
          name = node_wrapper.getNodeName()
          if name and cmds.objExists(name):
              return name

      # try .name property
      if hasattr(node_wrapper, 'name'):
          name = node_wrapper.name
          if name and cmds.objExists(name):
              return name

      # try finding by type pattern in recent nodes
      # MASH nodes typically have the network name as prefix
      pattern = f"*MASH_{node_type}*"
      matches = cmds.ls(pattern, type=f"MASH_{node_type}")
      if matches:
          # return most recently created (last in list after sort)
          return matches[-1]

      msg = f"could not resolve MASH {node_type} node name from wrapper"
      raise RuntimeError(msg)
  ```

  Place this method after the create_mash_network() method, before _create_mesh_distributed_network().
  </action>
  <verify>
  The function is added to generator.py. Run: `grep -n "_get_mash_node_name" src/maya_grass_gen/generator.py`
  Should show the new method definition.
  </verify>
  <done>
  Helper function exists in generator.py with try-except pattern for name resolution.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update all MASH node name usages to use helper</name>
  <files>src/maya_grass_gen/generator.py</files>
  <action>
  Update all four locations where MASH node names are used with setAttr():

  **Location 1: Point-based distribution path (lines 518-520)**
  Change from:
  ```python
  distribute = mash_network.addNode("MASH_Distribute")
  distribute_name = distribute.name
  cmds.setAttr(f"{distribute_name}.distribution", 0)
  ```
  To:
  ```python
  distribute = mash_network.addNode("MASH_Distribute")
  distribute_name = self._get_mash_node_name(distribute, "Distribute")
  cmds.setAttr(f"{distribute_name}.distribution", 0)
  ```

  **Location 2: Point-based python node (lines 526-527)**
  Change from:
  ```python
  python_node = mash_network.addNode("MASH_Python")
  python_node_name = python_node.name
  ```
  To:
  ```python
  python_node = mash_network.addNode("MASH_Python")
  python_node_name = self._get_mash_node_name(python_node, "Python")
  ```

  **Location 3: Mesh distributed path (lines 557-561)**
  Change from:
  ```python
  distribute = mash_network.addNode("MASH_Distribute")
  distribute_name = distribute.name
  # distribution mode 4 = mesh
  cmds.setAttr(f"{distribute_name}.distribution", 4)
  ```
  To:
  ```python
  distribute = mash_network.addNode("MASH_Distribute")
  distribute_name = self._get_mash_node_name(distribute, "Distribute")
  # distribution mode 4 = mesh
  cmds.setAttr(f"{distribute_name}.distribution", 4)
  ```

  **Location 4: Mesh distributed python node (lines 577-578)**
  Change from:
  ```python
  python_node = mash_network.addNode("MASH_Python")
  python_node_name = python_node.name
  ```
  To:
  ```python
  python_node = mash_network.addNode("MASH_Python")
  python_node_name = self._get_mash_node_name(python_node, "Python")
  ```

  Note: Keep all subsequent code using distribute_name and python_node_name unchanged.
  </action>
  <verify>
  Run: `grep -n "_get_mash_node_name" src/maya_grass_gen/generator.py | wc -l`
  Should return 5 (1 definition + 4 usages).

  Run: `grep -n "\.name$" src/maya_grass_gen/generator.py | grep -E "(distribute|python_node)"`
  Should return empty (no more direct .name access for MASH nodes).
  </verify>
  <done>
  All four MASH node name usages updated to use the helper function.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add defensive error handling for MASH network creation</name>
  <files>src/maya_grass_gen/generator.py</files>
  <action>
  Wrap the MASH network creation in both paths with try-except to provide clear error messages:

  **In create_mash_network() method (point-based path):**
  Wrap the distribute and python node creation (lines ~517-531) in try-except:
  ```python
  try:
      # point-based distribution (pre-computed positions with animated wind)
      distribute = mash_network.addNode("MASH_Distribute")
      distribute_name = self._get_mash_node_name(distribute, "Distribute")
      cmds.setAttr(f"{distribute_name}.distribution", 0)  # initial state
      cmds.setAttr(f"{distribute_name}.pointCount", len(self._grass_points))

      mash_network.setPointCount(len(self._grass_points))

      # set positions via MASH python node with animated wind
      python_node = mash_network.addNode("MASH_Python")
      python_node_name = self._get_mash_node_name(python_node, "Python")

      # generate animated wind code that recalculates rotation each frame
      wind_code = self._generate_point_based_wind_code()
      cmds.setAttr(f"{python_node_name}.pythonCode", wind_code, type="string")
  except RuntimeError as e:
      msg = f"failed to create MASH network '{network_name}': {e}"
      raise RuntimeError(msg) from e
  ```

  **In _create_mesh_distributed_network() method:**
  Wrap the main node creation logic (after target_mesh assignment) in try-except:
  ```python
  try:
      # add distribute node set to mesh distribution mode
      distribute = mash_network.addNode("MASH_Distribute")
      distribute_name = self._get_mash_node_name(distribute, "Distribute")

      # ... existing setAttr and mesh connection code ...

      # add python node for wind-based orientation
      python_node = mash_network.addNode("MASH_Python")
      python_node_name = self._get_mash_node_name(python_node, "Python")

      # generate wind expression that updates with time
      wind_code = self._generate_wind_python_code()
      cmds.setAttr(f"{python_node_name}.pythonCode", wind_code, type="string")
  except RuntimeError as e:
      msg = f"failed to create mesh-distributed MASH network '{network_name}': {e}"
      raise RuntimeError(msg) from e
  ```
  </action>
  <verify>
  Run: `grep -n "except RuntimeError" src/maya_grass_gen/generator.py`
  Should show at least 2 matches for the new error handling blocks.

  Run: `python -c "from maya_grass_gen.generator import GrassGenerator; print('import ok')"`
  Should print "import ok" without errors (syntax check).
  </verify>
  <done>
  Both MASH creation paths have try-except blocks with clear error messages.
  Import succeeds without syntax errors.
  </done>
</task>

</tasks>

<verification>
1. Module imports without errors:
   `python -c "from maya_grass_gen.generator import GrassGenerator"`

2. Helper function exists and is used:
   `grep -c "_get_mash_node_name" src/maya_grass_gen/generator.py` returns 5

3. No direct .name access on MASH node wrappers:
   `grep "distribute\.name\|python_node\.name" src/maya_grass_gen/generator.py` returns empty

4. Error handling present:
   `grep -c "except RuntimeError" src/maya_grass_gen/generator.py` returns >= 2
</verification>

<success_criteria>
1. _get_mash_node_name() helper function added with multiple resolution strategies
2. All 4 MASH node name usages updated to use the helper
3. Try-except error handling wraps both MASH creation paths
4. Module imports successfully (no syntax errors)
5. Error messages are clear about which node creation failed
</success_criteria>

<output>
After completion, create `.planning/phases/71-windfield-migration/71-03-SUMMARY.md`
</output>
